{% extends 'shop/basic.html' %}
{% block css %}
.col-md-3
{
display: inline-block;
margin-left:-4px;
}
.carousel-indicators .active {
background-color: blue;
}
.col-md-3 img{
width: 170px;
height: 200px;
}
body .carousel-indicator li{

background-color: blue;
}
body .carousel-indicators{
bottom: -40px;
}
.carousel-indicators li{
    background-color: #7270fc;
}
body .carousel-control-prev-icon,
body .carousel-control-next-icon{
background-color: blue;
}
.carousel-control-prev,
.carousel-control-next{
top: auto;
bottom: auto;
padding-top: 222px;
}
body .no-padding{
padding-left: 0,
padding-right: 0;
}
{% endblock %}
{% block body %}
{% load static %}
<div class="container">
    <!--Slideshow starts here -->
    {% for product, range, nSlides in allProds %}
    <h5 class="my-4">Flash Sale On {{product.0.category}} - Recommended Items</h5>
    <div class="row">
        <div id="demo{{forloop.counter}}" class="col carousel slide my-3" data-ride="carousel">
            <ul class="carousel-indicators">
                <li data-target="#demo{{forloop.counter}}" data-slide-to="0" class="active"></li>
                {% for i in range %}
                <li data-target="#demo{{forloop.parentloop.counter}}" data-slide-to="{{i}}"></li>
                {% endfor %}
            </ul>
            <div class="container carousel-inner no-padding">
                <div class="carousel-item active">
                    {% for i in product %}
                    <div style="float:left;width:43vw;max-height:500px;background-color:white;margin-left:2vw;border-radius:5px;border-color: red rgba(170, 50, 220, .6) green;box-shadow: 3px 3px 5px #888888;">
                  <div style="height:25vw;padding-left:10vw;padding-top:4vw">
                      <img src="/media/{{i.image}}" class="d-block" style="width:50%;height:auto;" alt="...">
                  </div>
                  <div style="padding-left:2vw;padding-top:4vw">
                    <h5 id="namepr{{i.id}}">{{i}}</h5>
                     <a href="#" class="btn btn-primary" id="pricepr{{i.id}}" style="background-color:orange">{{i.price}}</a>


                    <p>{{i.desc}}...</p>
                      <button type="submit" class="btn btn-primary cartx" id="pr{{i.id}}" style="float:left;margin-bottom:1vw;background-color:orange"><h2>+</h2></button>
                      <span class="prcount" style="display:none">{{i.id}}</span>
                      <button type="submit" class="btn btn-primary cartx"  style="float:left;margin-bottom:1vw;background-color:blue">
                          <h2 class="ordercount" id="ordercountpr{{i.id}}">0</h2>
                      </button>
                      <button type="submit" class="btn btn-primary delcartx" id="{{i.id}}" style="float:left;margin-bottom:1vw;background-color:orange"><h2>-</h2></button>
                      <a href="/shop/prodView/{{i.id}}" id="qv{{i.id}}" class="btn btn-primary" style="margin-bottom:1vw;margin-left:1vw">More</a>

                  </div>

              </div>
                    {% if forloop.counter|divisibleby:4 and forloop.counter > 0 and not forloop.last %}
                </div>
                <div class="carousel-item">
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- left and right controls for the slide -->
        <a class="carousel-control-prev" href="#demo{{forloop.counter}}" style="width:5vw" data-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </a>
        <a class="carousel-control-next" href="#demo{{forloop.counter}}" style="width:5vw" data-slide="next">
            <span class="carousel-control-next-icon"></span>
        </a>
    </div>
    {% endfor %}
</div>
{% endblock %}
{% block js %}
<script>

{%if msg|length != 0 %}
alert('{{msg}}');
window.location.href="/"
{%endif%}
// Find out the cart items from localStorage

        console.log("working")
        $(document).ready(function(){
          $('#popover').popover();
        });

        if(localStorage.getItem('cartx') == null){
        var cartx = {};
            console.log("workingif")

        }else{
        cartx = JSON.parse(localStorage.getItem('cartx'));
        console.log("workingelse")

        var total = 0;
        for(var item in cartx){
        if(cartx[item][0] != undefined) {
            total += cartx[item][0];
            console.log("counted after deleting")
        }
        }
        document.getElementById('cartx').innerHTML = total;


        var index = 0;
        var someElementsItems = document.querySelectorAll(".prcount");
        console.log("toatal products " + someElementsItems[someElementsItems.length-1].innerHTML)
        var prcount = someElementsItems[someElementsItems.length -1].innerHTML;



        for(var i=0; i<=prcount;i++){
            if(document.getElementsByClassName('ordercount')[i] != undefined){
            var idstr = document.getElementsByClassName('ordercount')[i].id;
            }else{
            break;
            }

            for(var j=0; j<Object.keys(cartx).length; j++){

                if(Object.keys(cartx)[j] == idstr.slice(10) & Object.values(cartx)[j][0] != null) {
                    document.getElementById(idstr).innerHTML = Object.values(cartx)[j][0];
                    console.log("0 ka chocla")
                    break;
                }else if(Object.values(cartx)[j][0] == null){
                    document.getElementById(idstr).innerHTML = 0;
                    console.log("setting 0 when null")
                }else{

                }
            }
        }

        updatePopover(cartx);
        function updatePopover(cartx)
        {
            console.log("updating cartx")
            var popStr = "";
            popStr = popStr + "<h5> Cartx for my items in my shopping cartx </h5><div class='mx-2 my-2'>";
            var i = 1;
            for (var item in cartx){
                console.log(item)
                var myElem = document.getElementById('name' + item);
                if (myElem === null){
                    console.log("item" + item +"not in search")
                }else{
                    if(cartx[item][0] > 0){
                        popStr = popStr + "<b>" + i + "</b>. ";
                        popStr = popStr + document.getElementById('name' + item).innerHTML.slice(0, 19) + "... Qty: " + cartx[item][0] + '<br>';
                        i = i+1;
                        }
                    }

                 }
            console.log(popStr)
            popStr = popStr + "</div>"
            document.getElementById('popover').setAttribute('data-bs-content', popStr);
        }



        }



        $('.cartx').click(function(){

        var idstr= this.id.toString();
        console.log(idstr);




        if(cartx[idstr] != undefined && cartx[idstr][0] != undefined ) {

        qty = cartx[idstr][0] + 1;
        name = document.getElementById('name'+idstr).innerHTML
        price = document.getElementById('price'+ idstr).innerHTML

        cartx[idstr] = [qty, name, price];

        var total = 0;
        for(var item in cartx){
        if(cartx[item][0] != undefined) {
            total += cartx[item][0];

        }
        }
        document.getElementById('cartx').innerHTML = total;

        var index = 0;
        for(var i=0; i<Object.keys(cartx).length; i++){
            if(Object.keys(cartx)[i] == idstr){
                index = i;
                console.log("index fixed")
                break;
            }else{
                index = -1;
            }
        }

        document.getElementById('cartx').innerHTML = total;
        console.log(Object.values(cartx)[index][0])
        document.getElementById('ordercount' + idstr).innerHTML = Object.values(cartx)[index][0];
        updatePopover(cartx);
        function updatePopover(cartx)
        {
            console.log("updating cartx")
            var popStr = "";
            popStr = popStr + "<h5> Cartx for my items in my shopping cartx </h5><div class='mx-2 my-2'>";
            var i = 1;
            for (var item in cartx){
             var myElem = document.getElementById('name' + item);
                if (myElem === null){
                    console.log("item" + item +"not in search")
                }else{
                    if(cartx[item][0] > 0){
                        popStr = popStr + "<b>" + i + "</b>. ";
                        popStr = popStr + document.getElementById('name' + item).innerHTML.slice(0, 19) + "... Qty: " + cartx[item][0] + '<br>';
                        i = i+1;
                        }

                }
                }
            console.log(popStr)
            popStr = popStr + "</div>"
            document.getElementById('popover').setAttribute('data-bs-content', popStr);
            $('#popover').popover('show');
        }


        }
        else{
        qty = 1;
        name = document.getElementById('name'+idstr).innerHTML
        price = document.getElementById('price'+ idstr).innerHTML
        cartx[idstr] = [qty, name, price];
        var total = 0;
        for(var item in cartx){
        if(cartx[item][0] != undefined) {
            total += cartx[item][0];
        }
        }
        document.getElementById('cartx').innerHTML = total;
        document.getElementById('ordercount' + idstr).innerHTML = 1;

        updatePopover(cartx);
        function updatePopover(cartx)
        {
            console.log("updating cartx")
            var popStr = "";
            popStr = popStr + "<h5> Cartx for my items in my shopping cartx </h5><div class='mx-2 my-2'>";
            var i = 1;
            for (var item in cartx){
            var myElem = document.getElementById('name' + item);
                if (myElem === null){
                    console.log("item" + item +"not in search")
                    popStr = popStr + "<b>" + i + "</b>. ";
                    popStr = popStr + document.getElementById('name' + item).innerHTML.slice(0, 19) + "... Qty: " + cartx[item][0] + '<br>';
                }else{
            if(cartx[item][0] > 0){
                popStr = popStr + "<b>" + i + "</b>. ";
                popStr = popStr + document.getElementById('name' + item).innerHTML.slice(0, 19) + "... Qty: " + cartx[item][0] + '<br>';
                i = i+1;
                }
            }
            }
            console.log(popStr)
            popStr = popStr + "</div>"
            document.getElementById('popover').setAttribute('data-bs-content', popStr);
            $('#popover').popover('show');
        }


        }
        console.log(cartx);
        localStorage.setItem('cartx', JSON.stringify(cartx));



        });





        $('.delcartx').click(function(){

        var delidstr= this.id.toString();
        var idstr = "pr" + delidstr
        var index = 0;
        for(var i=0; i<Object.keys(cartx).length; i++){
            if(Object.keys(cartx)[i] == idstr){
                index = i;
                console.log("index fixed")
                break;
            }else{
                index = -1;
            }
        }



        console.log(idstr);
        if(Object.values(cartx)[index][0] != undefined) {
            if(Object.values(cartx)[index][0] < 2 ){
                cartx[idstr][0] = undefined;
                cartx[idstr][1] = undefined;
                cartx[idstr][2] = undefined;

            }else{
                cartx[idstr][0] = cartx[idstr][0]-1;
            }

        var total = 0;
        for(var item in cartx){
        if(cartx[item][0] != undefined) {
            total += cartx[item][0];
            console.log("counted after deleting")
        }
        }
        document.getElementById('cartx').innerHTML = total;
        if(Object.values(cartx)[index][0] >0) {
        document.getElementById('ordercount' + idstr).innerHTML = Object.values(cartx)[index][0];
        }else{
        document.getElementById('ordercount' + idstr).innerHTML = 0;
        }
        updatePopover(cartx);
        function updatePopover(cartx)
        {
            console.log("updating cartx")
            var popStr = "";
            popStr = popStr + "<h5> Cartx for my items in my shopping cartx </h5><div class='mx-2 my-2'>";
            var i = 1;
            for (var item in cartx){
            var myElem = document.getElementById('name' + item);
                if (myElem === null){
                    console.log("item" + item +"not in search")
                }else{
                if(cartx[item][0] > 0){
                popStr = popStr + "<b>" + i + "</b>. ";
                popStr = popStr + document.getElementById('name' + item).innerHTML.slice(0, 19) + "... Qty: " + cartx[item][0] + '<br>';
                i = i+1;
                }
                }
            }
            console.log(popStr)
            popStr = popStr + "</div>"
            document.getElementById('popover').setAttribute('data-bs-content', popStr);
            $('#popover').popover('show');
        }


        }
        else{
        console.log("don't exists");


        }
        console.log(cartx);

        localStorage.setItem('cartx', JSON.stringify(cartx));



        });

</script>
{% endblock %}